<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0"/>
  <title>VPN Login</title>
  <link rel="stylesheet" href="css/custom.css" type="text/css"/>
  <script src="js/lib/jquery-1.9.1.min.js"></script>
  <script src="js/custom.js"></script>
  <script src="cordova.js"></script>
  <script type="text/javascript">
    // init phonegap when the DOM has been fully loaded
    $(document).ready(function() {
      document.addEventListener('deviceready', onDeviceReady, false);
    });

    function onDeviceReady() {
      if (isLoggedIn()) {
        doVPNRedirect()
      } else {
        showLoginPage();
      }
    }

    function doVPNRedirect() {
      showAlert("redirecting to VPN");
    }

    function showLoginPage() {
      showAlert("showin login page");
      initLoginPage();
      $('#loginPage').show();
    }
  </script>
</head>
<body>

  <div id="loginPage" data-role="page" data-theme="a" style="display: none">
    <script type="text/javascript">
      function redirect(pleaseTakeMeHere) {
        window.open(pleaseTakeMeHere, '_blank', 'location=yes');
      }

      function redirectAndAuthenticate(pleaseTakeMeHere, username, password) {
        var ref = window.open(pleaseTakeMeHere, '_blank', 'location=no');

        // Capture loadstart event
        ref.addEventListener('loadstart', function(event) {
          if (event.url.indexOf('wlan') > -1) {
            showAlert('wlan redirect');
            ref.close();

            var newUrl = event.url + "&user=" + username + "&password=" + password;
            showAlert('opening a new browser so we can adjust the event.url to: ' + newUrl);
            redirect(newUrl);
          }
        });
      }

      function initLoginPage() {
        var storedLoginName = getLoginName();
        if (storedLoginName != null && storedLoginName != "undefined") {
          $("#username").val(storedLoginName.toLowerCase());
        }
        $('#loginButton').bind('click', function() {
          setLoginName($('#username').val());
          setPassword($('#password').val());

          showAlert("hand over to inappbrowser");

          redirectAndAuthenticate("http://www.nu.nl", $('#username').val(), $('#password').val());
        })
      }
    </script>
    <h1>inloggen</h1>
    <div id="errors"></div>
    <div data-role="content">
      <form id="loginForm">
        <input type="text" name="username" id="username" placeholder="username" value="everbruggen" autocapitalize="off" autocomplete="off" autocorrect="off"/>
        <br/><br/>
        <input type="password" name="password" id="password" placeholder="password" value="vygq5440" autocapitalize="off" autocomplete="off" autocorrect="off"/>
        <br/>
        <br/>
        <br/>
        <input type="button" data-role="button" id="loginButton" data-icon="arrow-r" data-iconpos="right" data-theme="a" value="Login"/>
      </form>
    </div>
  </div>

</body>