<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0"/>
  <title>VPN Login</title>
  <link rel="stylesheet" href="css/custom.css" type="text/css"/>
  <script src="js/lib/jquery-1.9.1.min.js"></script>
  <script src="js/custom.js"></script>
  <script src="cordova.js"></script>
  <script type="text/javascript">
    "use strict";

    // init phonegap when the DOM has been fully loaded
    $(document).ready(function() {
      if (isMobile()) {
        document.addEventListener('deviceready', onDeviceReady, false);
      } else {
        onDeviceReady();
      }
    });

    function onDeviceReady() {
//      if (isLoggedIn()) {
//        redirectAndAuthenticate("http://www.google.com", getLoginName(), getPassword());
//      } else {
        showLoginPage();
        if (!isWiFiConnection()) {
          showAlert("Turn on WiFi first ;)");
        }
//      }
    }

    function doVPNRedirect() {
      showAlert("TODO: redirect to VPN");
    }

    function showLoginPage() {
      initLoginPage();
      $('#loginPage').show();
    }

    function redirect(pleaseTakeMeHere) {
      window.open(pleaseTakeMeHere, '_blank', 'location=yes');
    }

    function redirectAndAuthenticate(pleaseTakeMeHere, username, password) {
      var ref = window.open(pleaseTakeMeHere, '_blank', 'location=no');

      // Capture loadstart event
      ref.addEventListener('loadstart', function(event) {
        // if anything else than '.google.' is loaded..
        if (event.url.indexOf('.google.') == -1) {
          // close the browser..
          ref.close();
          // .. and open a new (augmented) one
          redirect(event.url + "&user=" + username + "&password=" + password);
        }
      });

      // Capture loadstop event
      ref.addEventListener('loadstop', function(event) {
        alert("load stopped");
//        alert("load stopped");
//        alert(event.url);
        // if anything else than '.google.' is loaded..
//        if (event.url.indexOf('.google.') == -1) {
          // close the browser..
//          ref.close();
          // something went wrong
//          showAlert("An error occured. Send this to the author please: error @ " + event.url);
//        } else {
          // google was loaded correctyle, so the user was already authenticated
//          showAlert("You're already authenticated for the VPN, so you can close this app.");
//        }
      });
    }

    function initLoginPage() {
      var storedLoginName = getLoginName();
      if (storedLoginName != null && storedLoginName != "undefined") {
        $("#username").val(storedLoginName);
      }

      var storedPassword = getPassword();
      if (storedPassword != null && storedPassword != "undefined") {
        $("#password").val(storedPassword);
      }

      $('#loginButton')
          .unbind('click')
          .bind('click', function() {
            setLoginName($('#username').val());
            setPassword($('#password').val());
            redirectAndAuthenticate("http://www.google.com", $('#username').val(), $('#password').val());
          });
    }
  </script>
</head>
<body>

  <div id="loginPage" data-role="page" data-theme="a" style="display: none">
    <h1>inloggen</h1>
    <div id="errors"></div>
    <div data-role="content">
      <form id="loginForm">
        <input type="text" name="username" id="username" placeholder="username" value="" autocapitalize="off" autocomplete="off" autocorrect="off"/>
        <br/><br/>
        <input type="password" name="password" id="password" placeholder="password" value="" autocapitalize="off" autocomplete="off" autocorrect="off"/>
        <br/>
        <br/>
        <br/>
        <input type="button" data-role="button" id="loginButton" data-icon="arrow-r" data-iconpos="right" data-theme="a" value="Login"/>
      </form>
    </div>
  </div>

</body>