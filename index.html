<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
  <meta charset="utf-8">
  <!--<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0"/>-->
  <title>WiFi login</title>
  <link rel="stylesheet" href="css/custom.css" type="text/css"/>
  <script src="js/lib/jquery-1.9.1.min.js"></script>
  <script src="js/custom.js"></script>
  <script src="cordova.js"></script>
  <script src="childbrowser.js"></script>
  <script type="text/javascript">
    "use strict";

    // init phonegap when the DOM has been fully loaded
    $(document).ready(function() {
      if (isMobile()) {
        document.addEventListener('deviceready', onDeviceReady, false);
      } else {
        onDeviceReady();
      }
    });

    function onDeviceReady() {
      initLoginPage();
      if (!isWiFiConnection()) {
        showAlert("Zet je WiFi even aan ;)");
      }
    }

    function openChildBrowser(pleaseTakeMeHere) {
      window.plugins.childBrowser.showWebPage(pleaseTakeMeHere, {showAddressBar: false, showLocationBar: false, showNavigationBar: false});
    }

    function redirectAndAuthenticate(pleaseTakeMeHere) {
      openChildBrowser(pleaseTakeMeHere);

      // Capture loadstart event
      window.plugins.childBrowser.onLocationChange = function (url) {
        debuglog("<br/>url: " + url);
        debuglog("<br/>closing browser in 3 sec");

        setTimeout(function() {
          // close the browser..
          window.plugins.childBrowser.close();

        // if anything else than 'x-services.nl' is loaded..
          if (url.indexOf('x-services.nl') == -1) {
            debuglog("closed by code, opening new one in 3 secs to " + url);

            setTimeout(function() {

              // .. and open a new (augmented) one
              openChildBrowser(url + "&user=" + $('#username').val() + "&password=" + $('#password').val());

              window.plugins.childBrowser.onLocationChange = function (url) {
                debuglog("<br/>url 2: " + url);
                // close the browser..
                window.plugins.childBrowser.close();
                feedback("Je bent nu ingelogd.");
              };

              // Capture loadstop event
//              ref.addEventListener('loadstop', function() {
//                debuglog("<br/>loading stopped, closing in 3 sec: " + event.url);
//                setTimeout(function() {
//                  ref.close();
//                }, 5000);
//              });
            }, 1000);
          } else {
            feedback("Je was nog ingelogd.");
          }
        }, 1000);
      };
    }

    function initLoginPage() {
      var storedLoginName = getLoginName();
      if (storedLoginName != null && storedLoginName != "undefined") {
        $("#username").val(storedLoginName);
      }

      var storedPassword = getPassword();
      if (storedPassword != null && storedPassword != "undefined") {
        $("#password").val(storedPassword);
      }

      $('#loginButton')
          .unbind('click')
          .bind('click', function() {
            setLoginName($('#username').val());
            setPassword($('#password').val());
            redirectAndAuthenticate("http://www.x-services.nl/wifilogin-ok.html");
          });
    }

    function feedback(what) {
      $("#feedback").html(what);
    }

    function debuglog(what) {
      $("#debuglog").append("<br/>"+new Date()+": "+what);
    }
  </script>
</head>
<body>

  <h1>WiFi login</h1>
  <div id="header">Je username en password worden onthouden in de app en verzonden naar de authenticatie server over een beveiligde verbinding.</div>
  <form id="loginForm">
    <input type="text" name="username" id="username" placeholder="username" value="" autocapitalize="off" autocomplete="off" autocorrect="off"/>
    <br/><br/>
    <input type="password" name="password" id="password" placeholder="password" value="" autocapitalize="off" autocomplete="off" autocorrect="off"/>
    <br/>
    <br/>
    <br/>
    <input type="button" data-role="button" id="loginButton" data-icon="arrow-r" data-iconpos="right" data-theme="a" value="Login"/>
  </form>

  <div id="footer">Zie je Google na klikken op Login?<br/>Dan ben je ingelogd en kun je de app sluiten.</div>

  <div id="feedback"></div>

  <div id="debuglog"></div>

</body>