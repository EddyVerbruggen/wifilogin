<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
  <meta charset="utf-8">
  <!--<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0"/>-->
  <title>WiFi login</title>
  <link rel="stylesheet" href="css/custom.css" type="text/css"/>
  <script src="js/lib/jquery-1.9.1.min.js"></script>
  <script src="js/custom.js"></script>
  <script src="cordova.js"></script>
  <script src="childbrowser.js"></script>
  <script type="text/javascript">
    "use strict";
    $(document).ready(function() {
      if (isMobile()) {
        document.addEventListener('deviceready', onDeviceReady, false);
      } else {
        onDeviceReady();
      }
    });

    function onDeviceReady() {
      initLoginPage();
      checkWiFi();
    }

    function checkWiFi() {
      if (isWiFiConnection()) {
        $("#noWiFiContainer").hide();
        $("#loginButton").show();
      } else {
        $("#noWiFiContainer").append(" .");
        setTimeout(function(){checkWiFi()}, 1000)
      }
    }

    function redirectAndAuthenticate(pleaseTakeMeHere) {
      openChildBrowser(pleaseTakeMeHere);

      // Capture loadstart event
      window.plugins.childBrowser.onLocationChange = function (url) {
        setTimeout(function() {
          // close the browser..
          window.plugins.childBrowser.close();

          // if anything else than 'x-services.nl' was loaded..
          if (url.indexOf('x-services.nl') == -1) {
            setTimeout(function() {
              // .. open a new one with added credentials
              openChildBrowser(url + "&user=" + $('#username').val() + "&password=" + $('#password').val());
              window.plugins.childBrowser.onLocationChange = function (url) {
                setTimeout(function() {
                  // ..a and close the browser
                  feedback("&check; Je bent nu ingelogd.");
                  window.plugins.childBrowser.close();
                }, childBrowserTimeout);
              };

            }, childBrowserTimeout);
          } else {
            feedback("&check; Je was reeds ingelogd.");
          }
        }, childBrowserTimeout);
      };
    }

    function initLoginPage() {
      var storedLoginName = getLoginName();
      if (storedLoginName != null && storedLoginName != "undefined") {
        $("#username").val(storedLoginName);
      }

      var storedPassword = getPassword();
      if (storedPassword != null && storedPassword != "undefined") {
        $("#password").val(storedPassword);
      }

      $('#loginButton')
          .unbind('click')
          .bind('click', function() {
            setLoginName($('#username').val());
            setPassword($('#password').val());
            redirectAndAuthenticate("http://www.x-services.nl/wifilogin-ok.html?ts=" + new Date().getTime());
          });
    }

    function feedback(what) {
      $("#feedback")
          .html(what)
          .show();
    }
  </script>
</head>
<body>

  <h1>WiFi login</h1>

  <div id="header">Je username en password worden onthouden in de app en verzonden naar de authenticatie server over een beveiligde verbinding.</div>

  <form id="loginForm">
    <input type="text" name="username" id="username" placeholder="username" value="" autocapitalize="off" autocomplete="off" autocorrect="off"/>
    <br/><br/>
    <input type="password" name="password" id="password" placeholder="password" value="" autocapitalize="off" autocomplete="off" autocorrect="off"/>
    <br/>
    <br/>
    <br/>
    <div id="noWiFiContainer">Wachtend op een WiFi signaal.</div>
    <input type="button" data-role="button" id="loginButton" data-icon="arrow-r" data-iconpos="right" data-theme="a" value="Login" style="display: none"/>
  </form>

  <div id="feedback"></div>

</body>