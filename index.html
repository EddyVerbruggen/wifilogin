<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
  <meta charset="utf-8">
  <!--<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0"/>-->
  <title>WiFi login</title>
  <link rel="stylesheet" href="css/custom.css" type="text/css"/>
  <script src="js/lib/jquery-1.9.1.min.js"></script>
  <script src="js/custom.js"></script>
  <script src="cordova.js"></script>
  <script type="text/javascript">
    "use strict";

    // init phonegap when the DOM has been fully loaded
    $(document).ready(function() {
      if (isMobile()) {
        document.addEventListener('deviceready', onDeviceReady, false);
      } else {
        onDeviceReady();
      }
    });

    function onDeviceReady() {
      initLoginPage();
      if (!isWiFiConnection()) {
        showAlert("Zet je WiFi even aan ;)");
      }
    }

    function redirectAndAuthenticate(pleaseTakeMeHere, username, password) {
      var ref = window.open(pleaseTakeMeHere, '_blank', 'location=yes');

      ref.addEventListener('loaderror', function(event) {
        debuglog("<br/>error: " + event.message);
      });

      // Capture loadstart event
      ref.addEventListener('loadstart', function(event) {
        // if anything else than 'x-services.nl' is loaded..
        debuglog("<br/>loadstart: " + event.url);
        if (event.url.indexOf('x-services.nl') == -1) {
          // close the browser..

          debuglog("<br/>closing browser in 5 sec");
          setTimeout(function() {
           ref.close();

            debuglog("closed by code, opening new one in 5 secs to " + event.url);

            setTimeout(function() {

              // .. and open a new (augmented) one
              var authRef = window.open(event.url + "&user=" + username + "&password=" + password, '_blank', 'location=yes');

              authRef.addEventListener('loaderror', function(event) {
                debuglog("<br/>error: " + event.message);
              });

              // Capture loadstop event
              authRef.addEventListener('loadstop', function(event) {
                debuglog("<br/>loading stopped, closing in 5 sec: " + event.url);
                setTimeout(function() {
                  authRef.close();
                }, 5000);
              });

            }, 5000);

          }, 5000);

        }
      });
    }

    function initLoginPage() {
      var storedLoginName = getLoginName();
      if (storedLoginName != null && storedLoginName != "undefined") {
        $("#username").val(storedLoginName);
      }

      var storedPassword = getPassword();
      if (storedPassword != null && storedPassword != "undefined") {
        $("#password").val(storedPassword);
      }

      $('#loginButton')
          .unbind('click')
          .bind('click', function() {
            setLoginName($('#username').val());
            setPassword($('#password').val());
            redirectAndAuthenticate("http://www.x-services.nl/wifilogin-ok.html", $('#username').val(), $('#password').val());
          });
    }

    function debuglog(what) {
      $("#debuglog").append("<br/>"+new Date()+": "+what);
    }
  </script>
</head>
<body>

  <h1>WiFi login</h1>
  <div id="header">Je username en password worden onthouden in de app en verzonden naar de authenticatie server over een beveiligde verbinding.</div>
  <form id="loginForm">
    <input type="text" name="username" id="username" placeholder="username" value="" autocapitalize="off" autocomplete="off" autocorrect="off"/>
    <br/><br/>
    <input type="password" name="password" id="password" placeholder="password" value="" autocapitalize="off" autocomplete="off" autocorrect="off"/>
    <br/>
    <br/>
    <br/>
    <input type="button" data-role="button" id="loginButton" data-icon="arrow-r" data-iconpos="right" data-theme="a" value="Login"/>
  </form>

  <div id="footer">Zie je Google na klikken op Login?<br/>Dan ben je ingelogd en kun je de app sluiten.</div>

  <div id="debuglog"></div>

</body>